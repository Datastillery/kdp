FROM jeffgrunewald/spark-2.4-base:1.0

ARG hadoop_version=2.8.5
ARG hive_version=3.1.1
ARG spark_version=2.4.0
ARG aws_sdk_version=1.11.467
ARG s3_url=https://s3.us-east-2.amazonaws.com/scos-third-party-repository

ENV HADOOP_HOME=/opt/hadoop \
    HIVE_HOME=/opt/hive \
    SPARK_HOME=/opt/spark

RUN wget ${s3_url}/hadoop/hadoop-${hadoop_version}.tar.gz && \
    tar zxf hadoop-${hadoop_version}.tar.gz && \
    mv hadoop-${hadoop_version} ${HADOOP_HOME} && \
    wget ${s3_url}/hive/apache-hive-${hive_version}-bin.tar.gz && \
    tar zxf apache-hive-${hive_version}-bin.tar.gz && \
    mv apache-hive-${hive_version}-bin ${HIVE_HOME} && \
    mv ${HADOOP_HOME}/share/hadoop/tools/lib/hadoop-aws-${hadoop_version}.jar ${HIVE_HOME}/lib/ && \
    mv ${HADOOP_HOME}/share/hadoop/tools/lib/aws-java-sdk-*.jar ${HIVE_HOME}/lib/ && \
    rm *.tar.gz && \
    rm -r ${HADOOP_HOME}/share/hadoop/tools/* && \
    rm -r ${HADOOP_HOME}/share/hadoop/yarn/* && \
    rm -r ${HADOOP_HOME}/share/doc

RUN wget ${s3_url}/aws-java-sdk/aws-java-sdk-${aws_sdk_version}.jar -P ${SPARK_HOME}/jars/ && \
    ln -s ${SPARK_HOME}/jars/aws-java-sdk-${aws_sdk_version}.jar ${HIVE_HOME}/lib/aws-java-sdk-${aws_sdk_version}.jar && \
    rm ${SPARK_HOME}/jars/{htrace-core-*,hadoop-annotations-*,hadoop-auth-*,hadoop-common-*,hadoop-hdfs-*,hive-*.spark2}.jar

RUN ln -s ${SPARK_HOME}/jars/spark-network-common_2.11-${spark_version}.jar ${HIVE_HOME}/lib/spark-network-common_2.11-${spark_version}.jar && \
    ln -s ${SPARK_HOME}/jars/scala-library-2.11.12.jar ${HIVE_HOME}/lib/scala-library-2.11.12.jar && \
    ln -s ${SPARK_HOME}/jars/spark-core_2.11-${spark_version}.jar ${HIVE_HOME}/lib/spark-core_2.11-${spark_version}.jar && \
    ln -s ${HIVE_HOME}/lib/hive-beeline-${hive_version}.jar ${SPARK_HOME}/jars/hive-beeline-${hive_version}.jar && \
    ln -s ${HIVE_HOME}/lib/hive-storage-api-2.7.0.jar ${SPARK_HOME}/jars/hive-storage-api-2.7.0.jar && \
    ln -s ${HADOOP_HOME}/share/hadoop/common/lib/hadoop-auth-${hadoop_version}.jar ${SPARK_HOME}/jars/hadoop-auth-${hadoop_version}.jar && \
    ln -s ${HADOOP_HOME}/share/hadoop/common/hadoop-common-${hadoop_version}.jar ${SPARK_HOME}/jars/hadoop-common-${hadoop_version}.jar && \
    ln -s ${HADOOP_HOME}/share/hadoop/hdfs/hadoop-hdfs-${hadoop_version}.jar ${SPARK_HOME}/jars/hadoop-hdfs-${hadoop_version}.jar && \
    ln -s ${HADOOP_HOME}/share/hadoop/hdfs/hadoop-hdfs-client-${hadoop_version}.jar ${SPARK_HOME}/jars/hadoop-hdfs-client-${hadoop_version}.jar && \
    ln -s ${HADOOP_HOME}/share/hadoop/hdfs/lib/htrace-core4-4.0.1-incubating.jar ${SPARK_HOME}/jars/htrace-core4-4.0.1-incubating.jar

COPY log4j.properties ${SPARK_HOME}/conf/log4j.properties
